name: Sync External Repositories
# åŒæ­¥å¤–éƒ¨å€‰åº«æª”æ¡ˆ

on:
  # Manual trigger / æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'è¦åŒæ­¥çš„å€‰åº«åç¨± (ç•™ç©ºå‰‡åŒæ­¥æ‰€æœ‰) / Repository name to sync (leave empty for all)'
        required: false
        type: string
  
  # Scheduled sync (weekly on Monday at 00:00 UTC) / å®šæ™‚åŒæ­¥ï¼ˆæ¯é€±ä¸€ UTC 00:00ï¼‰
  schedule:
    - cron: '0 0 * * 1'
  
  # On push to main branch when config file changes / ç•¶é…ç½®æª”æ¡ˆè®Šæ›´æ™‚
  push:
    branches:
      - main
    paths:
      - 'repos_sync.yaml'
      - '.github/workflows/sync-external-repos.yml'

jobs:
  sync:
    name: Sync Files from External Repositories
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: List configured repositories
        run: |
          echo "ðŸ“‹ é…ç½®çš„å€‰åº«åˆ—è¡¨:"
          python scripts/sync_external_repos.py --list
      
      - name: Run synchronization
        id: sync
        run: |
          if [ -n "${{ github.event.inputs.repo_name }}" ]; then
            echo "ðŸ”„ åŒæ­¥ç‰¹å®šå€‰åº«: ${{ github.event.inputs.repo_name }}"
            python scripts/sync_external_repos.py --repo "${{ github.event.inputs.repo_name }}"
          else
            echo "ðŸ”„ åŒæ­¥æ‰€æœ‰å€‰åº«"
            python scripts/sync_external_repos.py
          fi
        continue-on-error: true
      
      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "æœ‰æª”æ¡ˆè®Šæ›´ / Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status -s
          else
            echo "æ²’æœ‰æª”æ¡ˆè®Šæ›´ / No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "chore: sync files from external repositories

          Automated sync by GitHub Actions
          è‡ªå‹•åŒæ­¥å¤–éƒ¨å€‰åº«æª”æ¡ˆ
          
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Triggered by: ${{ github.event_name }}"
          
          git push origin ${{ github.ref_name }}
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”„ å€‰åº«åŒæ­¥æ‘˜è¦ / Repository Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¸ç™¼æ–¹å¼ / Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯ / Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ™‚é–“ / Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **ç‹€æ…‹ / Status:** å·²åŒæ­¥ä¸¦æäº¤è®Šæ›´ / Changes synced and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **ç‹€æ…‹ / Status:** æ²’æœ‰è®Šæ›´ / No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
