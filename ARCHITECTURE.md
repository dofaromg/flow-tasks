# FlowAgent 叢集部署流程圖

## 部署流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     開發者推送代碼到 GitHub                        │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │    GitHub Actions: CI Build         │
          │  (.github/workflows/ci-build.yml)   │
          │                                     │
          │  1. 建置 Docker 映像                 │
          │  2. 推送到 Artifact Registry         │
          │     - module-a:latest               │
          │     - orchestrator:latest           │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │    GitHub Actions: CD Deploy        │
          │  (.github/workflows/cd-deploy.yml)  │
          │                                     │
          │  1. 取得 GKE 憑證                    │
          │  2. Kustomize build                 │
          │  3. kubectl apply                   │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │         GKE Cluster                 │
          │    (modular-cluster)                │
          │                                     │
          │  Namespace: flowagent               │
          │  ├─ MongoDB (1 replica)             │
          │  ├─ Module-A (2 replicas + HPA)     │
          │  └─ Orchestrator (1 replica)        │
          │                                     │
          │  Namespace: monitoring              │
          │  └─ Prometheus                      │
          └─────────────────────────────────────┘
```

## ArgoCD GitOps 流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  開發者推送配置到 GitHub                          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │         ArgoCD Application          │
          │       (argocd/app.yaml)             │
          │                                     │
          │  監控 Git Repository                 │
          │  path: cluster/overlays/prod        │
          └────────────┬───────────────────────┘
                       │
                       │ 自動同步
                       │
                       ▼
          ┌────────────────────────────────────┐
          │      ArgoCD Server                  │
          │                                     │
          │  1. 檢測配置變更                     │
          │  2. 比對實際狀態                     │
          │  3. 自動同步 (automated)             │
          │  4. 自我修復 (selfHeal)              │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │         GKE Cluster                 │
          │    所有資源保持同步                   │
          └─────────────────────────────────────┘
```

## 本地開發流程

```
┌─────────────────────────────────────────────────────────────────┐
│              開發者在本地修改配置                                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │    驗證配置                          │
          │  bash scripts/validate_deployment.sh│
          │                                     │
          │  ✓ YAML 語法檢查                     │
          │  ✓ Kustomize 建置測試                │
          │  ✓ 映像參考檢查                      │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │    部署到叢集                        │
          │  kubectl apply -k cluster/overlays/prod │
          │                                     │
          │  或                                  │
          │                                     │
          │  git push (觸發 CI/CD 或 ArgoCD)     │
          └─────────────────────────────────────┘
```

## 服務架構

```
                        ┌──────────────────┐
                        │   Load Balancer  │
                        │  (外部 IP)        │
                        └────────┬─────────┘
                                 │
                        ┌────────▼─────────┐
                        │  Orchestrator    │
                        │  Service (LB)    │
                        │  Port: 80        │
                        └────────┬─────────┘
                                 │
                        ┌────────▼──────────┐
                        │  Orchestrator     │
                        │  Pod (8081)       │
                        └─┬────────────┬────┘
                          │            │
              ┌───────────▼─┐      ┌──▼──────────┐
              │  Module-A   │      │   MongoDB   │
              │  Service    │      │   Service   │
              │  (ClusterIP)│      │  (ClusterIP)│
              └──────┬──────┘      └──────┬──────┘
                     │                    │
              ┌──────▼──────┐      ┌──────▼──────┐
              │  Module-A   │      │   MongoDB   │
              │  Pods       │      │   Pod       │
              │  (2 replicas)│      │             │
              │  + HPA      │      │  + PVC 10Gi │
              └─────────────┘      └─────────────┘

監控系統 (monitoring namespace):
              ┌─────────────┐
              │ Prometheus  │
              │ (抓取指標)   │
              └──────┬──────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
  ┌─────────┐  ┌─────────┐  ┌─────────┐
  │Module-A │  │Orchestr.│  │ MongoDB │
  │ /metrics│  │ /metrics│  │ /metrics│
  └─────────┘  └─────────┘  └─────────┘
```

## 自動擴展流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   負載增加 (流量上升)                              │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │  HPA 監控指標                        │
          │  - CPU 使用率 > 70%                  │
          │  - Memory 使用率 > 80%               │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  HPA 決策                            │
          │  計算目標 replica 數量                │
          │  (min: 2, max: 10)                  │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  擴展 Deployment                     │
          │  建立新的 Pod                        │
          │  等待 Pod 就緒                       │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  Service 自動負載均衡                 │
          │  流量分散到所有 Pod                   │
          └─────────────────────────────────────┘
```

## 資料持久化

```
┌─────────────────────────────────────────────────────────────────┐
│                   MongoDB 資料寫入                                │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │  MongoDB Pod                        │
          │  掛載 Volume                        │
          │  /data/db                           │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  PersistentVolumeClaim              │
          │  mongodb-pvc (10Gi)                 │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  PersistentVolume                   │
          │  GCE Persistent Disk                │
          │  (standard-rwo)                     │
          └─────────────────────────────────────┘

註：即使 Pod 重啟或重新調度，資料仍然保留在 PV 中
```

## 網路流量

```
Internet
    │
    ▼
┌──────────────┐
│ Load Balancer│  ← GCP L4 Load Balancer
└──────┬───────┘
       │
       ▼
┌──────────────────────────┐
│  orchestrator Service     │  ← Kubernetes Service (LoadBalancer)
│  External IP: 34.x.x.x   │
│  Port: 80 → 8081         │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│  orchestrator Pod         │
│  IP: 10.x.x.x            │
│  Port: 8081              │
└──────┬───────────────────┘
       │
       ├─────────────────────┐
       │                     │
       ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ module-a Svc │      │ mongodb Svc  │  ← 內部 ClusterIP Services
│ 10.y.y.y:8080│      │ 10.z.z.z:27017│
└──────┬───────┘      └──────┬───────┘
       │                     │
       ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ module-a Pods│      │ mongodb Pod  │
└──────────────┘      └──────────────┘
```

## 部署時間表

```
時間軸                     活動
─────────────────────────────────────────────────
T + 0m         │ 執行初始化腳本
               │ ├─ 設定 GCP 專案
               │ └─ 啟用 APIs
               │
T + 2m         │ 建立 GKE 叢集 (如果需要)
               │ └─ 約需 5-10 分鐘
               │
T + 12m        │ 部署應用程式
               │ ├─ 建立 namespace
               │ ├─ 部署 MongoDB
               │ ├─ 部署 Module-A
               │ └─ 部署 Orchestrator
               │
T + 15m        │ 等待所有 Pod 就緒
               │ └─ health checks 通過
               │
T + 16m        │ LoadBalancer IP 分配
               │ └─ 可以訪問服務
               │
T + 17m        │ 部署完成 ✓
```

## 監控和告警流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   Pod 暴露 /metrics 端點                          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────────┐
          │  Prometheus 抓取指標                 │
          │  - 每 15 秒抓取一次                  │
          │  - 存儲時序資料                      │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  Prometheus 評估規則                 │
          │  - CPU 使用率                        │
          │  - Memory 使用率                     │
          │  - 請求錯誤率                        │
          └────────────┬───────────────────────┘
                       │
                       ▼
          ┌────────────────────────────────────┐
          │  觸發告警 (可選)                     │
          │  - Alertmanager                     │
          │  - Email / Slack / PagerDuty        │
          └─────────────────────────────────────┘
```

---

以上流程圖展示了 FlowAgent 系統的完整部署和運行架構。
