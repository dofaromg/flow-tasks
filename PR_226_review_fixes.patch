From 0e562fb4d3dab782a7e5b69543060ba09ed9a94d Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 16 Jan 2026 15:48:42 +0000
Subject: [PATCH] Fix PR #226 review comments - address security, code quality,
 and type issues

Co-authored-by: dofaromg <217537952+dofaromg@users.noreply.github.com>
---
 flowos/README.md               |  4 +++-
 flowos/src/core/config.ts      |  4 ++--
 flowos/src/core/gate.ts        |  2 +-
 flowos/src/core/neural_link.ts |  2 +-
 flowos/src/index.ts            | 29 +++++------------------------
 5 files changed, 12 insertions(+), 29 deletions(-)

diff --git a/flowos/README.md b/flowos/README.md
index e1a229f..c16c6ff 100644
--- a/flowos/README.md
+++ b/flowos/README.md
@@ -132,13 +132,15 @@ const result = flow.enforce(context);
 # Build TypeScript
 npm run build
 
-# Run tests
+# Run demo (manual validation script, not automated tests)
 npm run test
 
 # Type check without emitting files
 npm run typecheck
 ```
 
+Note: `npm run test` runs a demonstration script (`test.ts`) that exercises the core FlowOS functionality. It's not an automated test suite, but rather a manual validation tool.
+
 ## Storage
 
 All data is stored in-memory using the `MemoryStorage` class, which provides:
diff --git a/flowos/src/core/config.ts b/flowos/src/core/config.ts
index fa12337..3d5164b 100644
--- a/flowos/src/core/config.ts
+++ b/flowos/src/core/config.ts
@@ -21,8 +21,8 @@ export class ConfigManager {
   }
 
   update(partial: ConfigSnapshot): void {
-    const previous = this.snapshot;
-    this.snapshot = { ...previous, ...partial };
+    const previous = { ...this.snapshot };
+    this.snapshot = { ...this.snapshot, ...partial };
     this.notify(previous);
   }
 
diff --git a/flowos/src/core/gate.ts b/flowos/src/core/gate.ts
index 948a1af..9be6b35 100644
--- a/flowos/src/core/gate.ts
+++ b/flowos/src/core/gate.ts
@@ -26,4 +26,4 @@ export class FlowGate {
   }
 }
 
-export class GateEngine extends FlowGate {}
+export type GateEngine = FlowGate;
diff --git a/flowos/src/core/neural_link.ts b/flowos/src/core/neural_link.ts
index ab92398..1f0cc37 100644
--- a/flowos/src/core/neural_link.ts
+++ b/flowos/src/core/neural_link.ts
@@ -97,7 +97,7 @@ export class ParticleNeuralLink {
       'X-Node-Id': this.nodeId,
     };
     if (this.env.GITHUB_TOKEN) {
-      headers.Authorization = `Bearer ${this.env.GITHUB_TOKEN}`;
+      headers.Authorization = `token ${this.env.GITHUB_TOKEN}`;
     }
     const response = await fetch(`https://api.github.com${path}`, {
       method,
diff --git a/flowos/src/index.ts b/flowos/src/index.ts
index e050a4c..1ca4ecc 100644
--- a/flowos/src/index.ts
+++ b/flowos/src/index.ts
@@ -86,7 +86,6 @@ export default {
   async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
     // A. Build neural link (Synapse)
     const synapse = new ParticleNeuralLink(env, 'Edge-Node-L2');
-    const gateEngine = new GateEngine();
     const url = new URL(request.url);
     const path = url.pathname;
 
@@ -111,16 +110,10 @@ export default {
       }
 
       // D. Core business logic
-      const memory = new Memory(env.MRLIOUWORD_VAULT);
       const persona = new Persona(env.MRLIOUWORD_VAULT);
-      const auth = new Auth(env.PARTICLE_AUTH_VAULT || env.MRLIOUWORD_VAULT);
       const vcs = new VersionControl(env.MRLIOUWORD_VAULT, synapse);
 
-      void auth;
-      void gateEngine;
-      void memory;
-
-      const key = request.headers.get('X-Master-Key') || url.searchParams.get('key');
+      const key = request.headers.get('X-Master-Key');
       const publicPaths = ['/', '/status', '/heartbeat', '/world/heartbeat', '/frequencies'];
       if (
         env.MASTER_KEY &&
@@ -128,7 +121,7 @@ export default {
         !publicPaths.includes(path) &&
         !path.startsWith('/auth/init')
       ) {
-        return new Response(JSON.stringify({ error: 'Unauthorized', origin: env.ORIGIN }), { status: 401 });
+        return json({ error: 'Unauthorized', origin: env.ORIGIN }, 401);
       }
 
       // VCS - Sync GitHub
@@ -164,8 +157,6 @@ export default {
         }),
         { status: 503 },
       );
-    } finally {
-      ctx.waitUntil(Promise.resolve());
     }
   },
 };
@@ -238,12 +229,14 @@ class VersionControl {
   }
 
   async add(path: string, content: string) {
+    // TODO: Implement VCS add functionality
     void path;
     void content;
     return { success: true };
   }
 
   async commit(msg: string, pid: string) {
+    // TODO: Implement VCS commit functionality
     void msg;
     void pid;
     return { success: true, hash: 'new_hash' };
@@ -255,14 +248,8 @@ class VersionControl {
 }
 
 // ============================================
-// 6. Other Classes (Memory, Persona, Auth)
+// 6. Other Classes (Persona)
 // ============================================
-class Memory {
-  constructor(private kv: KVNamespace) {
-    void this.kv;
-  }
-}
-
 class Persona {
   constructor(private kv: KVNamespace) {
     void this.kv;
@@ -277,12 +264,6 @@ class Persona {
   }
 }
 
-class Auth {
-  constructor(private kv: KVNamespace) {
-    void this.kv;
-  }
-}
-
 // ============================================
 // 7. Worker Runtime Types (stubs for build-time)
 // ============================================
-- 
2.52.0

